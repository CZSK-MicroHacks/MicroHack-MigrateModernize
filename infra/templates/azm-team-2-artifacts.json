{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "eastus2euap",
            "type": "String"
        },
        "projectName": {
            "defaultValue": "testPortalDisconnected5",
            "type": "String"
        },
        "subscriptionId": {
            "defaultValue": "31be0ff4-c932-4cb3-8efc-efa411d79280",
            "type": "String"
        }
    },
    "variables": {
        "applianceName": "[concat(parameters('projectName'), 'collector')]",
        "assessmentProjectName": "[concat(parameters('projectName'), '1191project')]",
        "vmwareSiteName": "[concat(parameters('projectName'), '3685site')]",
        "masterSiteName": "[concat(parameters('projectName'), '9371masterSite')]",
        "sqlSiteName": "[concat(parameters('projectName'), '9371sqlsites')]",
        "webAppSiteName": "[concat(parameters('projectName'), '9371webappsites')]",
        "pgsqlSiteName": "[concat(parameters('projectName'), '9371pgsql')]",
        "mysqlSiteName": "[concat(parameters('projectName'), '9371mysql')]"
    },
    "resources": [
        {
            "type": "Microsoft.Migrate/assessmentprojects",
            "apiVersion": "2020-01-01",
            "name": "[variables('assessmentProjectName')]",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "projectStatus": "Active",
                "assessmentSolutionId": "[resourceId('Microsoft.Migrate/MigrateProjects/Solutions', parameters('projectName'), 'Servers-Assessment-ServerAssessment')]",
                "publicNetworkAccess": null,
                "customerWorkspaceId": null,
                "customerWorkspaceLocation": null,
                "customerStorageAccountArmId": null
            }
        },
        {
            "type": "Microsoft.Migrate/MigrateProjects/Solutions",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('projectName'), '/Servers-Assessment-ServerAssessment')]",
            "dependsOn": [
                "[resourceId('Microsoft.Migrate/assessmentprojects', variables('assessmentProjectName'))]"
            ],
            "properties": {
                "cleanupState": "None",
                "details": {
                    "groupCount": 0,
                    "assessmentCount": 0,
                    "extendedDetails": {
                        "projectId": "[resourceId('Microsoft.Migrate/assessmentprojects', variables('assessmentProjectName'))]"
                    }
                },
                "goal": "Servers",
                "purpose": "Assessment",
                "status": "Active",
                "summary": {
                    "instanceType": "Servers",
                    "discoveredCount": 0,
                    "assessedCount": 0,
                    "replicatingCount": 0,
                    "testMigratedCount": 0,
                    "migratedCount": 0
                },
                "tool": "ServerAssessment"
            }
        },
        {
            "type": "Microsoft.OffAzure/VMwareSites",
            "apiVersion": "2020-07-10",
            "name": "[variables('vmwareSiteName')]",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "applianceName": "[variables('applianceName')]",
                "servicePrincipalIdentityDetails": {
                    "tenantId": "tenantId",
                    "applicationId": "applicationId",
                    "objectId": "objectId",
                    "audience": "audience",
                    "aadAuthority": "aadAuthority"
                },
                "discoverySolutionId": "[resourceId('Microsoft.Migrate/MigrateProjects/Solutions', parameters('projectName'), 'Servers-Discovery-ServerDiscovery')]"
            }
        },
        {
            "type": "Microsoft.Migrate/assessmentprojects/vmwarecollectors",
            "apiVersion": "2025-09-09-preview",
            "name": "[concat(variables('assessmentProjectName'), '/', variables('vmwareSiteName'), 'vmwarecollector')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                "[resourceId('Microsoft.Migrate/assessmentprojects', variables('assessmentProjectName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "agentProperties": {
                    "id": "[reference(resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName')), '2020-07-10').agentDetails.id]",
                    "spnDetails": {
                        "authority": "authority",
                        "applicationId": "appId",
                        "audience": "audience",
                        "objectId": "objectid",
                        "tenantId": "tenantid"
                    }
                },
                "discoverySiteId": "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]"
            }
        },
        {
            "type": "Microsoft.ApplicationMigration/PGSQLSites",
            "apiVersion": "2025-02-01-preview",
            "name": "[variables('pgsqlSiteName')]",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "properties": {
                "masterSiteId": "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]",
                "migrateProjectId": "[resourceId('Microsoft.Migrate/migrateProjects', parameters('projectName'))]"
            }
        },
        {
            "type": "Microsoft.MySQLDiscovery/MySQLSites",
            "apiVersion": "2024-12-30-preview",
            "name": "[variables('mysqlSiteName')]",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "properties": {
                "masterSiteId": "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]",
                "migrateProjectId": "[resourceId('Microsoft.Migrate/migrateProjects', parameters('projectName'))]"
            }
        },
        {
            "type": "Microsoft.OffAzure/MasterSites",
            "apiVersion": "2020-07-07",
            "name": "[variables('masterSiteName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                "[resourceId('Microsoft.ApplicationMigration/PGSQLSites', variables('pgsqlSiteName'))]",
                "[resourceId('Microsoft.MySQLDiscovery/MySQLSites', variables('mysqlSiteName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "allowMultipleSites": true,
                "sites": [
                    "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                    "[resourceId('Microsoft.ApplicationMigration/PGSQLSites', variables('pgsqlSiteName'))]",
                    "[resourceId('Microsoft.MySQLDiscovery/MySQLSites', variables('mysqlSiteName'))]"
                ]
            }
        },
        {
            "type": "Microsoft.OffAzure/MasterSites/SqlSites",
            "apiVersion": "2022-10-27",
            "name": "[concat(variables('masterSiteName'), '/', variables('sqlSiteName'))]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "discoverySolutionId": "[resourceId('Microsoft.Migrate/MigrateProjects/Solutions', parameters('projectName'), 'Servers-Discovery-ServerDiscovery')]",
                "siteAppliancePropertiesCollection": [
                    {
                        "servicePrincipalIdentityDetails": {
                            "tenantId": "tenantId",
                            "applicationId": "applicationId",
                            "objectId": "objectId",
                            "audience": "audience",
                            "aadAuthority": "aadAuthority"
                        },
                        "applianceName": "[variables('applianceName')]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OffAzure/MasterSites/SqlSites/DiscoverySiteDataSources",
            "apiVersion": "2020-11-11-preview",
            "name": "[concat(variables('masterSiteName'), '/', variables('sqlSiteName'), '/vmwarediscoverysource')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                "[resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "properties": {
                "discoverySiteId": "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]"
            }
        },
        {
            "type": "Microsoft.Migrate/assessmentprojects/sqlcollectors",
            "apiVersion": "2023-03-15",
            "name": "[concat(variables('assessmentProjectName'), '/', variables('sqlSiteName'), 'collector')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName'))]",
                "[resourceId('Microsoft.Migrate/assessmentprojects', variables('assessmentProjectName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "agentProperties": {
                    "id": "[reference(resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName')), '2023-06-06').siteAppliancePropertiesCollection[0].agentDetails.id]",
                    "spnDetails": {
                        "authority": "authority",
                        "applicationId": "appId",
                        "audience": "audience",
                        "objectId": "objectid",
                        "tenantId": "tenantid"
                    }
                },
                "discoverySiteId": "[resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName'))]"
            }
        },
        {
            "type": "Microsoft.OffAzure/MasterSites/WebAppSites",
            "apiVersion": "2020-11-11-preview",
            "name": "[concat(variables('masterSiteName'), '/', variables('webAppSiteName'))]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "discoverySolutionId": "[resourceId('Microsoft.Migrate/MigrateProjects/Solutions', parameters('projectName'), 'Servers-Discovery-ServerDiscovery')]",
                "siteAppliancePropertiesCollection": [
                    {
                        "servicePrincipalIdentityDetails": {
                            "tenantId": "tenantId",
                            "applicationId": "applicationId",
                            "objectId": "objectId",
                            "audience": "audience",
                            "aadAuthority": "aadAuthority"
                        },
                        "applianceName": "[variables('applianceName')]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OffAzure/MasterSites/WebAppSites/DiscoverySiteDataSources",
            "apiVersion": "2020-11-11-preview",
            "name": "[concat(variables('masterSiteName'), '/', variables('webAppSiteName'), '/vmwarediscoverysource')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                "[resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "properties": {
                "discoverySiteId": "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]"
            }
        },
        {
            "type": "Microsoft.Migrate/assessmentprojects/webappcollectors",
            "apiVersion": "2023-03-15",
            "name": "[concat(variables('assessmentProjectName'), '/', variables('webAppSiteName'), 'collector')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName'))]",
                "[resourceId('Microsoft.Migrate/assessmentprojects', variables('assessmentProjectName'))]"
            ],
            "tags": {
                "Migrate Project": "[parameters('projectName')]"
            },
            "kind": "Migrate",
            "properties": {
                "agentProperties": {
                    "id": "[reference(resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName')), '2023-06-06').siteAppliancePropertiesCollection[0].agentDetails.id]",
                    "spnDetails": {
                        "authority": "authority",
                        "applicationId": "appId",
                        "audience": "audience",
                        "objectId": "objectid",
                        "tenantId": "tenantid"
                    }
                },
                "discoverySiteId": "[resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName'))]"
            }
        },
        {
            "type": "Microsoft.Migrate/MigrateProjects/Solutions",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('projectName'), '/Servers-Discovery-ServerDiscovery')]",
            "dependsOn": [
                "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]",
                "[resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName'))]",
                "[resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName'))]",
                "[resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName'))]"
            ],
            "properties": {
                "tool": "ServerDiscovery",
                "purpose": "Discovery",
                "goal": "Servers",
                "status": "Inactive",
                "cleanupState": "None",
                "summary": {
                    "instanceType": "Servers",
                    "discoveredCount": 0,
                    "assessedCount": 0,
                    "replicatingCount": 0,
                    "testMigratedCount": 0,
                    "migratedCount": 0
                },
                "details": {
                    "groupCount": 0,
                    "assessmentCount": 0,
                    "extendedDetails": {
                        "masterSiteId": "[resourceId('Microsoft.OffAzure/MasterSites', variables('masterSiteName'))]",
                        "applianceNameToSiteIdMapV3": "[concat('[{\"', variables('applianceName'), '\":{\"ApplianceName\":\"', variables('applianceName'), '\",\"SiteId\":\"', resourceId('Microsoft.OffAzure/VMwareSites', variables('vmwareSiteName')), '\",\"ApplianceDetails\":{\"isRegistered\":\"true\"}}}]')]",
                        "supportedScenarioSites": "[concat('{ \"SqlSites\": \"', resourceId('Microsoft.OffAzure/MasterSites/SqlSites', variables('masterSiteName'), variables('sqlSiteName')), '\", \"WebAppSites\": \"', resourceId('Microsoft.OffAzure/MasterSites/WebAppSites', variables('masterSiteName'), variables('webAppSiteName')), '\" }')]"
                    }
                }
            }
        }
    ]
}